"use strict";function ListNode(e,t){this._id="number"==typeof e?e:null,this._data=t||null,this.next=null,this.prev=null}function LinkedList(){this.start=new ListNode,this.end=new ListNode,this.start.next=this.end,this.start.prev=null,this.end.prev=this.start,this.end.next=null,this._idCounter=0,this._numNodes=0}function ZegoWebSocket(e,t){if(this.url=e,this.protocol=t||null,this.readyState=3,this._websocket=wx.connectSocket({url:e}),this._websocket){this.readyState=0;var r=this;this._websocket.onOpen(function(e){r.readyState=r._websocket.readyState,"function"==typeof r.onopen&&(r.onopen(),r._websocket.onClose(function(e){r.readyState=r._websocket.readyState,"function"==typeof r.onclose&&r.onclose(e)}),r._websocket.onMessage(function(e){"function"==typeof r.onmessage&&r.onmessage(e)}))}),this._websocket.onError(function(e){r.readyState=r._websocket.readyState,"function"==typeof r.onerror&&r.onerror(e)})}}ListNode.prototype={id:function(e){if(null==e)return this._id;if("number"!=typeof e)throw new Error("Id must be an integer.");this._id=e},data:function(e){if(null==e)return this._data;this._data=e},hasNext:function(){return null!==this.next&&null!==this.next.id()},hasPrev:function(){return null!==this.prev&&null!==this.prev.id()}},LinkedList.prototype={insertBefore:function(e,t){var r=new ListNode(this._idCounter,t);return r.next=e,r.prev=e.prev,e.prev.next=r,e.prev=r,++this._idCounter,++this._numNodes,r},addLast:function(e){return this.insertBefore(this.end,e)},add:function(e){return this.addLast(e)},getFirst:function(){return 0===this._numNodes?null:this.start.next},getLast:function(){return 0===this._numNodes?null:this.end.prev},size:function(){return this._numNodes},getFromFirst:function(e){var t=0,r=this.start.next;if(e>=0)for(;t<e&&null!==r;)r=r.next,++t;else r=null;if(null===r)throw"Index out of bounds.";return r},get:function(e){return 0===e?this.getFirst():e===this._numNodes-1?this.getLast():this.getFromFirst(e)},remove:function(e){return e.prev.next=e.next,e.next.prev=e.prev,--this._numNodes,e},removeFirst:function(){var e=null;return this._numNodes>0&&(e=this.remove(this.start.next)),e},removeLast:function(){var e=null;return this._numNodes>0&&(e=this.remove(this.end.prev)),e},removeAll:function(){this.start.next=this.end,this.end.prev=this.start,this._numNodes=0,this._idCounter=0},each:function(e){for(var t=this.start;t.hasNext();)e(t=t.next)},find:function(e){for(var t=this.start,r=!1,s=null;t.hasNext()&&!r;)e(t=t.next)&&(s=t,r=!0);return s},map:function(e){for(var t=this.start,r=[];t.hasNext();)e(t=t.next)&&r.push(t);return r},push:function(e){return this.addLast(e)},unshift:function(e){this._numNodes>0?this.insertBefore(this.start.next,e):this.insertBefore(this.end,e)},pop:function(){return this.removeLast()},shift:function(){return this.removeFirst()}},ZegoWebSocket.prototype.onopen=function(e){},ZegoWebSocket.prototype.onerror=function(e){},ZegoWebSocket.prototype.onclose=function(e){},ZegoWebSocket.prototype.onmessage=function(e){},ZegoWebSocket.prototype.send=function(e){this._websocket&&this._websocket.send({data:e})},ZegoWebSocket.prototype.close=function(){this._websocket&&this._websocket.close()};var ENUM_LOG_LEVEL={debug:0,info:1,warn:2,error:3,report:99,disable:100},ENUM_REMOTE_TYPE={disable:0,websocket:1,https:2};function ZegoLogger(){this.logSeq=0,this.logLevel=ENUM_LOG_LEVEL.disable,this.logRemoteLevel=ENUM_LOG_LEVEL.disable,this.websocket=null,this.url="",this.appid=0,this.sessionid="0",this.roomid="",this.userid="",this.userName="",this.logCache=[],this.logCacheSend=[],this.logCacheMax=100,this.logType=ENUM_REMOTE_TYPE.disable,this.logUploadTimer=null,this.logUploadInterval=1e4,this.version=""}ZegoLogger.prototype.setLogLevel=function(e){this.logLevel=e,(this.logLevel<ENUM_LOG_LEVEL.debug||this.logLevel>ENUM_LOG_LEVEL.report)&&(this.logLevel=ENUM_LOG_LEVEL.disable)},ZegoLogger.prototype.setRemoteLogLevel=function(e){this.logRemoteLevel=e,(this.logRemoteLevel<ENUM_LOG_LEVEL.debug||this.logRemoteLevel>ENUM_LOG_LEVEL.report)&&(this.logRemoteLevel=ENUM_LOG_LEVEL.disable)},ZegoLogger.prototype.setSessionInfo=function(e,t,r,s,o,i){this.appid=e,this.roomid=t,this.sessionid=r,this.userid=s,this.userName=o,this.version=i},ZegoLogger.prototype.openLogServer=function(e){0==e.indexOf("wss:")?(this.logType=ENUM_REMOTE_TYPE.websocket,openWebSocketLogServer(this,e)):0==e.indexOf("https:")?(this.logType=ENUM_REMOTE_TYPE.https,openHttpsLogServer(this,e)):this.logType=ENUM_REMOTE_TYPE.disable},ZegoLogger.prototype.stopLogServer=function(){this.logType==ENUM_REMOTE_TYPE.websocket?stopWebSocketServer(this):this.logType==ENUM_LOG_LEVEL.https&&(SendHttpsLog(this),stopHttpsServer(this)),this.logType=ENUM_REMOTE_TYPE.disable},ZegoLogger.prototype.RemoteLog=function(e,t,r){""!=this.url&&(this.logType==ENUM_REMOTE_TYPE.websocket?RemoteWebSocketLog(this,e,t):this.logType==ENUM_REMOTE_TYPE.https&&RemoteHttpsLog(this,e,t,r))},ZegoLogger.prototype.log=function(e,t){if(this.logLevel!==ENUM_LOG_LEVEL.disable&&this.logLevel<=e)for(this.logCache.push(t);this.logCache.length>this.logCacheMax;)this.logCache.shift();this.logRemoteLevel!==ENUM_LOG_LEVEL.disable&&this.logRemoteLevel<=e&&this.RemoteLog(e,t)},ZegoLogger.prototype.debug=function(){var e=logParamList(this,"debug","".concat([].slice.call(arguments)));this.logLevel!==ENUM_LOG_LEVEL.disable&&this.logLevel<=ENUM_LOG_LEVEL.debug&&console.debug.apply(console,e),this.log(ENUM_LOG_LEVEL.debug,e)},ZegoLogger.prototype.info=function(){var e=logParamList(this,"info","".concat([].slice.call(arguments)));this.logLevel!==ENUM_LOG_LEVEL.disable&&this.logLevel<=ENUM_LOG_LEVEL.info&&console.info.apply(console,e),this.log(ENUM_LOG_LEVEL.info,e)},ZegoLogger.prototype.warn=function(){var e=logParamList(this,"warn","".concat([].slice.call(arguments)));this.logLevel!==ENUM_LOG_LEVEL.disable&&this.logLevel<=ENUM_LOG_LEVEL.warn&&console.warn.apply(console,e),this.log(ENUM_LOG_LEVEL.warn,e)},ZegoLogger.prototype.error=function(){var e=logParamList(this,"error","".concat([].slice.call(arguments)));this.logLevel!==ENUM_LOG_LEVEL.disable&&this.logLevel<=ENUM_LOG_LEVEL.error&&console.error.apply(console,e),this.log(ENUM_LOG_LEVEL.error,e)},ZegoLogger.prototype.report=function(e){var t=logReportParamList(this,"report",e);this.logLevel!==ENUM_LOG_LEVEL.disable&&this.logLevel<=ENUM_LOG_LEVEL.report&&console.info.apply(console,t),this.RemoteLog(ENUM_LOG_LEVEL.report,t,!0)};var D=["00","01","02","03","04","05","06","07","08","09"];function logReportParamList(e,t,r){var s=new Date,o=1900+s.getYear()+"/";return o+=(D[s.getMonth()+1]||s.getMonth()+1)+"/",o+=(D[s.getDate()]||s.getDate())+" ",o+=(D[s.getHours()]||s.getHours())+":",o+=(D[s.getMinutes()]||s.getMinutes())+":",o+=D[s.getSeconds()]||s.getSeconds(),o+="."+s.getTime()%1e3,r.time=o,r.level=t,r.console="xcx",r.appid=e.appid,r.roomid=e.roomid,r.userid=e.userid,r.id_name=e.userid,r.userName=e.userName,r.sessionid=e.sessionid,r.version=e.version,[JSON.stringify(r)]}function logParamList(e,t,r){var s=new Date,o=1900+s.getYear()+"/";o+=(D[s.getMonth()+1]||s.getMonth()+1)+"/",o+=(D[s.getDate()]||s.getDate())+" ",o+=(D[s.getHours()]||s.getHours())+":",o+=(D[s.getMinutes()]||s.getMinutes())+":",o+=D[s.getSeconds()]||s.getSeconds(),o+="."+s.getTime()%1e3;var i=r.substr(0,r.indexOf(" "));0==i.length&&(i=r);var a=r.substr(r.indexOf(" ")+1);0==a.length&&(a="");var n={time:o,level:t,action:i,content:a,appid:e.appid,roomid:e.roomid,userid:e.userid,userName:e.userName,sessionid:e.sessionid};return[JSON.stringify(n)]}function openWebSocketLogServer(e,t){if(e.url!=t){if(e.url=t,stopWebSocketServer(),!t)return;e.websocket=new ZegoWebSocket(t),e.websocket.onopen=function(e){},e.websocket.onclose=function(e){},e.websocket.onmessage=function(e){},e.websocket.onerror=function(e){console.log("ws发生错误！")}}}function openHttpsLogServer(e,t){e.url=t,t&&(stopHttpsServer(e),e.logUploadTimer||(e.logUploadTimer=setInterval(function(){SendHttpsLog(e)},e.logUploadInterval)))}function stopWebSocketServer(e){e.websocket&&(e.websocket.onclose=null,e.websocket.onerror=null,e.websocket.close(),e.websocket=null)}function stopHttpsServer(e){e.logUploadTimer&&(clearInterval(e.logUploadTimer),e.logUploadTimer=null)}function RemoteWebSocketLog(e,t,r){if(null==e.websocket||2==e.websocket.readyState||3==e.websocket.readyState){var s=e.url;e.url="",e.openLogServer(s),e.logCacheSend.length<e.logCacheMax&&e.logCacheSend.push(r)}else if(0==e.websocket.readyState)e.logCacheSend.length<e.logCacheMax&&e.logCacheSend.push(r);else if(1==e.websocket.readyState){if(e.logCacheSend>0){for(var o="",i=0;i<e.logCacheSend.length;i++)o=o+e.logCacheSend[i]+"\n";r=o+r,e.logCacheSend=[]}e.websocket.send(r)}else e.logCacheSend.length<e.logCacheMax&&e.logCacheSend.push(r)}function RemoteHttpsLog(e,t,r,s){e.logCacheSend.push(r),(e.logCacheSend.length>=e.logCacheMax||!0===s)&&SendHttpsLog(e)}function SendHttpsLog(e){if(0!=e.logCacheSend.length){for(var t="",r=0;r<e.logCacheSend.length;r++)t=t+e.logCacheSend[r]+"\n";wx.request({url:e.url,data:t,method:"POST",success:function(t){if(0!=t.data.length){var r=t.data.interval;"number"==typeof r&&e.logUploadInterval!==r&&(e.timeInterval=r,openHttpsLogServer(e,e.url))}},fail:function(e){console.log("send failed "+e.statusCode)}}),e.logCacheSend=[]}}var ENUM_PLAY_STATE={start:0,playing:1,stop:2};function ZegoPlayer(e,t,r,s,o,i,a,n){this.streamid=t,this.urls=r,this.playUrlIndex=0,this.playUrlTryCount=0,this.currentUrl=null,this.reconnectLimit=o,this.reconnectCount=0,this.state=ENUM_PLAY_STATE.stop,this.logger=e,this.playcenter=i,this.sourceType=a,this.playerType=n,this.params=s,this.playerSeq=0,this.publishQualitySeq=0,this.publishQualityCount=0,this.publishQulaityMaxCount=10,this.everSuccess=!1}function resetPlayer(e){e.state=ENUM_PLAY_STATE.stop}function newPlayer(e){resetPlayer(e);var t=e.getCurrentPlayerUrl(),r=t;return 0!=e.params.length&&(r=t+"?"+e.params),t!==e.currentUrl?(e.currentUrl=t,e.playcenter.onStreamUrlUpdate(e.streamid,r,e.playerType)):e.playcenter.onPlayerRetry(e.streamid,e.playerType),0==e.everSuccess?0==e.playerType?(e.playcenter.eventStart(e.playerSeq,"PlayBegin"),e.playcenter.addEventInfo(e.playerSeq,"PlayBegin","url",r)):(e.playcenter.eventStart(e.playerSeq,"PublishBegin"),e.playcenter.addEventInfo(e.playerSeq,"PublishBegin","url",r)):0==e.playerType?e.playcenter.addEventInfo(e.playerSeq,"PlayRetry","url",r):e.playcenter.eventStart(e.playerSeq,"PublishRetry","url",r),e.state=ENUM_PLAY_STATE.start,!0}function shouldRetryPlay(e,t){var r=t.detail.code;return 3001==r||3002==r||3003==r||3005==r}function isPlayFailed(e,t){var r=t.detail.code;return-2301==r||-2302==r||2101==r||2102==r}function shouldRetryPublish(e,t){var r=t.detail.code;return 3001==r||3002==r||3003==r||3004==r||3005==r}function isPublishFailed(e,t){var r=t.detail.code;return-1301==r||-1302==r||-1303==r||-1304==r||-1305==r||-1306==r||-1307==r||-1308==r||-1309==r||-1310==r||-1311==r}function reportQualityStatics(e){e.playcenter.uploadReport(e.publishQualitySeq,"WXPublishStateUpdate"),e.publishQualityCount=0,e.publishQualitySeq=0}ZegoPlayer.prototype.stopPlayer=function(){0==this.playerType?(this.playcenter.addEventInfo(this.playerSeq,"PlayStat","quality",this.playerInfo),this.playcenter.eventEnd(this.playerSeq,"PlayStat")):(this.playcenter.addEventInfo(this.playerSeq,"PublishStat","quality",this.playerInfo),this.playcenter.eventEnd(this.playerSeq,"PublishStat"))},ZegoPlayer.prototype.tryStartPlayer=function(e){for(;this.playUrlTryCount<this.urls.length;)if(++this.reconnectCount>this.reconnectLimit)this.playUrlTryCount++,this.playUrlIndex=(this.playUrlIndex+1)%this.urls.length,this.reconnectCount=0;else if(this.logger.info("zp.tsp.0 index: "+this.playUrlIndex+", url: "+this.getCurrentPlayerUrl()),newPlayer(this))break;if(this.playUrlTryCount>=this.urls.length){this.logger.info("zp.tsp.0 stream: "+this.streamid),resetPlayer(this);var t="";0==this.playerType?t="PlayEnd":1==this.playerType&&(t="PublishEnd",reportQualityStatics(this));var r={error:e,reason:"no url to retry"};this.playcenter.addEvent(this.playerSeq,t,r),this.playcenter.onPlayerStop(this.streamid,this.playerType,e)}},ZegoPlayer.prototype.updateEvent=function(e){if(0==this.playerType){if(2004==e.detail.code)this.everSuccess?this.playcenter.eventEnd(this.playerSeq,"PlayRetry"):(this.everSuccess=!0,this.playcenter.eventStart(this.playerSeq,"PlayStat")),this.playcenter.onPlayerStart(this.streamid,this.playerType);else if(shouldRetryPlay(this,e))this.playcenter.eventStart(this.playerSeq,"PlayRetry"),this.playcenter.addEventInfo(this.playerSeq,"PlayRetry","error_code",e.detail.code);else if(isPlayFailed(this,e)){this.logger.info("zp.ue.0 play error: "+this.streamid),resetPlayer(this);var t={errorCode:e.detail.code};this.playcenter.addEvent(this.playerSeq,"PlayError",t),this.playcenter.onPlayerStop(this.streamid,this.playerType,e.detail.code)}this.everSuccess||this.playcenter.eventEnd(this.playerSeq,"PlayBegin")}else if(1==this.playerType){if(1002==e.detail.code)this.everSuccess?this.playcenter.eventEnd(this.playerSeq,"PublishRetry"):(this.everSuccess=!0,this.playcenter.eventStart(this.playerSeq,"PublishStat")),this.playcenter.onPlayerStart(this.streamid,this.playerType);else if(shouldRetryPublish(this,e))this.playcenter.eventStart(this.playerSeq,"PublishRetry"),this.playcenter.addEventInfo(this.playerSeq,"PublishRetry","error_code",e.detail.code);else if(isPublishFailed(this,e)){this.logger.info("zp.ue.0 publish error: "+this.streamid),resetPlayer(this);var r={errorCode:e.detail.code};this.playcenter.addEvent(this.playerSeq,"PublishError",r),reportQualityStatics(this),this.playcenter.onPlayerStop(this.streamid,this.playerType,e.detail.code)}this.everSuccess||this.playcenter.eventEnd(this.playerSeq,"PublishBegin")}},ZegoPlayer.prototype.updatePlayerNetStatus=function(e){var t={videoBitrate:e.detail.info.videoBitrate,audioBitrate:e.detail.info.audioBitrate,videoFPS:e.detail.info.videoFPS,videoHeight:e.detail.info.videoHeight,videoWidth:e.detail.info.videoWidth};if(this.playerInfo=t,1==this.playerType){var r={videoBitrate:e.detail.info.videoBitrate,audioBitrate:e.detail.info.audioBitrate,videoFPS:e.detail.info.videoFPS,videoGOP:e.detail.info.videoGOP,netSpeed:e.detail.info.netSpeed,netJitter:e.detail.info.netJitter,videoWidth:e.detail.info.videoWidth,videoHeight:e.detail.info.videoHeight};0==this.publishQualitySeq&&(this.publishQualitySeq=this.playcenter.newReport()),this.playcenter.addEvent(this.publishQualitySeq,"PublishQuality",r),this.publishQualityCount+=1,this.publishQualityCount>=this.publishQulaityMaxCount&&reportQualityStatics(this)}this.playcenter.onPlayerQuality(this.streamid,t,this.playerType)},ZegoPlayer.prototype.getCurrentPlayerUrl=function(){return this.urls[this.playUrlIndex%this.urls.length]};var ENUM_PLAY_STATE_UPDATE={start:0,stop:1,retry:2},ENUM_PLAYER_TYPE={play:0,publish:1};function ZegoPlayerCenter(e){this.playerList={},this.playerCount=0,this.logger=e,this.playingList=[],this.publishingList=[],this.playerStatistics={},this.eventSeq=0,this.streamEventMap={}}function updateStreamState(e,t,r,s){if(null!=e)if(null!=r&&"string"==typeof r||(r=""),1==t)s.push({streamid:e,params:r});else for(var o=0;o<s.length;o++)if(s[o].streamid==e){s.splice(o,1);break}}function startPlayer(e,t,r,s,o){var i=e.playerList[t];if(i)return!0;var a=[];o==ENUM_PLAYER_TYPE.play?a=e.playingList:o==ENUM_PLAYER_TYPE.publish&&(a=e.publishingList);for(var n=!1,l="",g=0;g<a.length;g++)if(a[g].streamid==t){n=!0,l=a[g].params;break}if(!n)return e.logger.warn("zpc.sp.0 should not start"),!1;if((i=e.playerList[t]=new ZegoPlayer(e.logger,t,r,l,getReconnectLimit(e.dispatchType),e,s,o)).playerSeq=e.streamEventMap[t],!i)return e.logger.info("zpc.sp.0 new player failed"),!1;++e.playerCount;var u=i.tryStartPlayer(0);return e.logger.debug("zpc.sp.0 call result:",u),u}function stopPlayer(e,t){var r=e.playerList[t];r&&(r.stopPlayer(),delete e.playerList[t],--e.playerCount),e.logger.debug("zpc.sp.1.0 call success")}function reportPublishEvent(e,t,r){if(e.streamEventMap[t]){var s=e.streamEventMap[t],o=e.playerStatistics[s];null!=o&&(o.msg_ext={stream:t},o.itemType="WXPublishStream",o.time_consumed=Date.now()-o.abs_time,null!=r&&(o.error=r),e.logger.report(o),delete e.streamEventMap[t],delete e.playerStatistics[s])}}function reportPlayEvent(e,t){if(e.streamEventMap[t]){var r=e.streamEventMap[t],s=e.playerStatistics[r];null!=s&&(s.itemType="WXPlayStream",s.time_consumed=Date.now()-s.abs_time,e.logger.report(s),delete e.streamEventMap[t],delete e.playerStatistics[r])}}function getReconnectLimit(e){return 1}ZegoPlayerCenter.prototype.updatePlayingState=function(e,t,r){null!=e&&(updateStreamState(e,r,t,this.playingList),r?(this.streamEventMap[e]=this.newReport(),this.eventStart(this.streamEventMap[e],"GetPlayInfo")):reportPlayEvent(this,e))},ZegoPlayerCenter.prototype.updatePublishingState=function(e,t,r){null!=e&&(updateStreamState(e,r,t,this.publishingList),r?(this.streamEventMap[e]=this.newReport(),this.eventStart(this.streamEventMap[e],"GotPublishInfo")):reportPublishEvent(this,e))},ZegoPlayerCenter.prototype.isPlaying=function(){return 0!=this.playingList.length},ZegoPlayerCenter.prototype.isPublishing=function(){return 0!=this.publishingList.length},ZegoPlayerCenter.prototype.startPlayingStream=function(e,t,r){this.logger.debug("zpc.sps.0 call");var s=this.streamEventMap[e];return s&&(this.addEventInfo(s,"GetPlayInfo","urls",t),this.eventEnd(s,"GetPlayInfo")),startPlayer(this,e,t,r,ENUM_PLAYER_TYPE.play)},ZegoPlayerCenter.prototype.stopPlayingStream=function(e){this.logger.debug("zpc.sps.1.0 call"),null!=e&&(stopPlayer(this,e),this.updatePlayingState(e))},ZegoPlayerCenter.prototype.startPublishingStream=function(e,t,r){this.logger.debug("zpc.sps.1 call");var s=this.streamEventMap[e];return s&&(this.addEventInfo(s,"GotPublishInfo","urls",t),this.eventEnd(s,"GotPublishInfo")),startPlayer(this,e,t,r,ENUM_PLAYER_TYPE.publish)},ZegoPlayerCenter.prototype.stopPublishingStream=function(e){this.logger.debug("zpc.sps.1.1 call"),null!=e&&(stopPlayer(this,e),this.updatePublishingState(e,!1))},ZegoPlayerCenter.prototype.updatePlayerState=function(e,t){var r=this.playerList[e];r&&r.updateEvent(t),this.logger.debug("zpc.upe.1.0 updatePlayerEvent success")},ZegoPlayerCenter.prototype.updatePlayerNetStatus=function(e,t){var r=this.playerList[e];r&&r.updatePlayerNetStatus(t),this.logger.debug("zpc.upns.1.0 updatePlayerNetStatus success")},ZegoPlayerCenter.prototype.reset=function(){this.logger.debug("zpc.r.0 call");for(var e=0;e<this.playingList.length;e++)this.stopPlayingStream(this.playingList[e]);for(var t=0;t<this.publishingList.length;t++)this.stopPublishingStream(this.publishingList[t]);this.playerCount=0,this.playerList={},this.playerWaitingList=[],this.playerStatistics={},this.streamEventMap={},this.logger.debug("zpc.r.0 call success")},ZegoPlayerCenter.prototype.newReport=function(){var e=++this.eventSeq;return this.playerStatistics[e]=[],this.playerStatistics[e]={abs_time:Date.now(),time_consumed:0,error:0,events:[]},e},ZegoPlayerCenter.prototype.eventStart=function(e,t){this.playerStatistics[e]&&null!=this.playerStatistics[e].events&&this.playerStatistics[e].events.push({event:t,abs_time:Date.now(),time_consumed:0})},ZegoPlayerCenter.prototype.addEventInfo=function(e,t,r,s){if(this.playerStatistics[e]){var o=this.playerStatistics[e].events;if(null!=o)for(var i=o.length-1;i>=0;i--)if(o[i].event==t&&null!=o[i].time_consumed){null==o[i].msg_ext&&(o[i].msg_ext={}),o[i].msg_ext[r]=s;break}}},ZegoPlayerCenter.prototype.eventEnd=function(e,t){if(this.playerStatistics[e]){var r=this.playerStatistics[e].events;if(null!=r)for(var s=r.length-1;s>=0;s--)if(r[s].event==t&&null!=r[s].time_consumed){r[s].time_consumed=Date.now()-r[s].abs_time;break}}},ZegoPlayerCenter.prototype.addEvent=function(e,t,r){this.playerStatistics[e]&&(null==r&&(r={}),null!=this.playerStatistics[e].events&&this.playerStatistics[e].events.push({event:t,abs_time:Date.now(),msg_ext:r}))},ZegoPlayerCenter.prototype.uploadReport=function(e,t){var r=this.playerStatistics[e];null!=r&&(r.itemType=t,r.time_consumed=Date.now()-r.abs_time,this.logger.report(r),delete this.playerStatistics[e])},ZegoPlayerCenter.prototype.onPlayStateUpdate=function(e,t,r){},ZegoPlayerCenter.prototype.onPlayQualityUpdate=function(e,t){},ZegoPlayerCenter.prototype.onPublishStateUpdate=function(e,t){},ZegoPlayerCenter.prototype.onPublishQualityUpdate=function(e,t){},ZegoPlayerCenter.prototype.onStreamUrlUpdate=function(e,t){},ZegoPlayerCenter.prototype.onPlayerStart=function(e,t){this.logger.debug("ops.0 call"),t==ENUM_PLAYER_TYPE.play?this.onPlayStateUpdate(ENUM_PLAY_STATE_UPDATE.start,e,0):t==ENUM_PLAYER_TYPE.publish&&this.onPublishStateUpdate(ENUM_PLAY_STATE_UPDATE.start,e,0)},ZegoPlayerCenter.prototype.onPlayerStop=function(e,t,r){this.logger.debug("ops.1 call"),t==ENUM_PLAYER_TYPE.play?(reportPlayEvent(this,e,r),this.logger.warn("ops.1 play error"),this.onPlayStateUpdate(ENUM_PLAY_STATE_UPDATE.stop,e,r)):t==ENUM_PLAYER_TYPE.publish&&(reportPublishEvent(this,e,r),this.logger.warn("ops.1 publish error"),this.onPublishStateUpdate(ENUM_PLAY_STATE_UPDATE.stop,e,r))},ZegoPlayerCenter.prototype.onPlayerRetry=function(e,t){this.logger.debug("opr.0 call"),t==ENUM_PLAYER_TYPE.play?this.onPlayStateUpdate(ENUM_PLAY_STATE_UPDATE.retry,e,0):t==ENUM_PLAYER_TYPE.publish&&this.onPublishStateUpdate(ENUM_PLAY_STATE_UPDATE.retry,e,0)},ZegoPlayerCenter.prototype.onPlayerQuality=function(e,t,r){r==ENUM_PLAYER_TYPE.play?this.onPlayQualityUpdate(e,t):r==ENUM_PLAYER_TYPE.play&&this.onPublishQualityUpdate(e,t)},ZegoPlayerCenter.prototype.onStreamUrlUpdate=function(e,t,r){this.logger.debug("opuu.0 call"),this.onStreamUrlUpdate(e,t,r)};var ENUM_PLAY_SOURCE_TYPE={auto:0,ultra:1},ENUM_DISPATCH_TYPE={cdn:0,ultra:1},ENUM_RUN_STATE={logout:0,trylogin:1,login:2},ENUM_STREAM_UPDATE_TYPE={added:0,deleted:1},ENUM_STREAM_UPDATE_CMD={added:12001,deleted:12002,updated:12003},MAX_TRY_LOGIN_COUNT=5,TRY_LOGIN_INTERVAL=[2e3,2e3,3e3,3e3,4e3],MAX_TRY_HEARTBEAT_COUNT=3,MINIUM_HEARTBEAT_INTERVAL=3e3,PROTO_VERSION="1.0.3",ENUM_SIGNAL_SUB_CMD={none:0,joinLiveRequest:1001,joinLiveResult:1002,joinLiveInvite:1003,joinLiveStop:1004},ENUM_PUSH_SIGNAL_SUB_CMD={none:0,pushJoinLiveRequest:11001,pushJoinLiveResult:11002,pushJoinLiveInvite:11003,pushJoinLiveStop:11004},ENUM_STREAM_SUB_CMD={liveNone:0,liveBegin:2001,liveEnd:2002,liveUpdate:2003},ENUM_PUBLISH_STREAM_STATE={waiting_url:1,tryPublish:2,update_info:3,publishing:4,stop:5};function ZegoClient(){this.appid=0,this.server="",this.idName="",this.nickName="",this.configOK=!1,this.logger=new ZegoLogger,this.userStateUpdate=!1,this.userSeq=0,this.userQuerying=!1,this.userTempList=[],this.roomCreateFlag=1,this.roomid="",this.token="",this.role=0,this.callbackList={},this.runState=ENUM_RUN_STATE.logout,this.lastRunState=ENUM_RUN_STATE.logout,this.userid="",this.sessionid="",this.cmdSeq=0,this.websocket=null,this.globalHeader=null,this.tryLoginCount=0,this.tryLoginTimer=null,this.tryHeartbeatCount=0,this.tryHeartbeatTimer=null,this.heartbeatInterval=3e4,this.ultraPlaySourceType="rtmp_v2",this.streamList=[],this.streamQuerying=!1,this.preferPlaySourceType=ENUM_PLAY_SOURCE_TYPE.auto,this.preferPublishSourceType=ENUM_DISPATCH_TYPE.ultra,this.currentPlaySourceType=ENUM_DISPATCH_TYPE.cdn,this.playerCenter=new ZegoPlayerCenter(this.logger),this.playerCenter.onPlayStateUpdate=this.onPlayStateUpdateHandle.bind(this),this.playerCenter.onPlayQualityUpdate=this.onPlayQualityUpdateHandle.bind(this),this.playerCenter.onStreamUrlUpdate=this.onStreamUrlUpdateHandle.bind(this),this.playerCenter.onPublishStateUpdate=this.onPublishStateUpdateHandle.bind(this),this.playerCenter.onPublishQualityUpdate=this.onPublishQualityUpdateHandle.bind(this),this.sendDataMap={},this.sendDataList=new LinkedList,this.sendDataCheckTimer=null,this.sendDataCheckInterval=2e3,this.sendDataTimeout=5e3,this.sendDataDropTimeout=1e4,this.sendDataCheckOnceCount=100,this.sendRoomMsgTime=0,this.SendRoomMsgInterval=500,this.joinLiveCallbackMap={},this.joinLiveRequestMap={},this.publishStreamList={},this.sendCommandMap={},this.sendCommandList=new LinkedList,this.streamUrlMap={},this.serverTimeOffset=0,this.bigimTimeWindow=0,this.datiTimeWindow=0,this.transSeqMap={},this.bigImLastTimeIndex=0,this.bigImMessageList=[],this.bigImTimer=null,this.bigImCallbackMap={},this.realyMessageList=[],this.relayTimer=null}function startPlayingStreamFromCDN(e,t){e.logger.debug("zc.p.spsfc.0 call");for(var r=null,s=0;s<e.streamList.length;s++)if(e.streamList[s].stream_id===t){r=e.streamList[s].url_rtmp||[];break}return!r||r.length<=0?(e.logger.error("zc.p.spsfc.0 cannot find stream url"),!1):(e.currentPlaySourceType=ENUM_DISPATCH_TYPE.cdn,e.logger.debug("zc.p.spsfc.0 play stream"),doPlayStream(e,t,[r]))}function startPlayingStreamFromBGP(e,t){return e.currentPlaySourceType=ENUM_DISPATCH_TYPE.ultra,e.logger.info("zc.p.sps.0 fetch stream url"),fetchPlayStreamUrl(e,t),!0}function doPlayStream(e,t,r){return e.logger.debug("zc.p.dps.0 call"),!(!r||r.length<=0)&&(e.playerCenter.startPlayingStream(t,r,e.currentPlaySourceType),!0)}function doPublishStream(e,t,r){return e.logger.debug("zc.p.dps.1 call"),!(!r||r.length<=0)&&(e.logger.info("zc.p.dps.1 streamid: "+t+"streamUrl: "+r),e.playerCenter.startPublishingStream(t,r,e.preferPublishSourceType),e.logger.debug("zc.p.dps.1 call success"),!0)}function checkConfigParam(e){return!0}function checkLoginParam(e){return!0}function checkCustomCommandParam(e){return!0}function registerCallback(e,t,r){var s=function(){},o=function(){};r.success&&"function"==typeof r.success&&(s=r.success),r.error&&"function"==typeof r.error&&(o=r.error),e.callbackList[t+"SuccessCallback"]=s,e.callbackList[t+"ErrorCallback"]=o}function actionSuccessCallback(e,t){return e.callbackList[t+"SuccessCallback"]}function actionErrorCallback(e,t){return e.callbackList[t+"ErrorCallback"]}function getServerError(e){var t={1:"parse json error.",1001:"login is processing.",1002:"liveroom request error.",1003:"zpush connect fail.",1004:"zpush handshake fail.",1005:"zpush login fail.",1006:"user login state is wrong.",1007:"got no zpush addr",1008:"token error",1009:"dispatch error",1000000000:"liveroom cmd error, result="};if(0===e)return{code:"ZegoClient.Success",msg:"success"};var r={code:"ZegoClient.Error.Server"};return r.msg=e>1e9?t[1e9]+e:null!=t[e]?t[e]:"unknown error code:"+e,r}ZegoClient.prototype.onPlayStateUpdateHandle=function(e,t,r){1==e&&this.stopPlayingStream(t),this.onPlayStateUpdate(e,t,r)},ZegoClient.prototype.onPlayQualityUpdateHandle=function(e,t){this.onPlayQualityUpdate(e,t)},ZegoClient.prototype.onStreamUrlUpdateHandle=function(e,t,r){this.onStreamUrlUpdate(e,t,r)},ZegoClient.prototype.onPublishStateUpdateHandle=function(e,t,r){0==e?this.publishStreamList[t]&&(this.publishStreamList[t].state==ENUM_PUBLISH_STREAM_STATE.tryPublish?(this.publishStreamList[t].state=ENUM_PUBLISH_STREAM_STATE.update_info,updateStreamInfo(this,t,ENUM_STREAM_SUB_CMD.liveBegin,this.publishStreamList[t].extra_info)):this.publishStreamList[t].state==ENUM_PUBLISH_STREAM_STATE.publishing&&this.onPublishStateUpdate(e,t,r)):(1==e&&this.stopPublishingStream(t),this.onPublishStateUpdate(e,t,r))},ZegoClient.prototype.onPublishQualityUpdateHandle=function(e,t){this.onPublishQualityUpdate(e,t)},ZegoClient.prototype.config=function(e){return this.logger.debug("zc.p.c.0 call"),checkConfigParam(e)?(this.appid=e.appid,this.server=e.server,this.idName=e.idName,this.nickName=e.nickName,this.logger.setLogLevel(e.logLevel),!1===e.audienceCreateRoom&&(this.roomCreateFlag=0),null!=e.remoteLogLevel?this.logger.setRemoteLogLevel(e.remoteLogLevel):this.logger.setRemoteLogLevel(0),this.logger.setSessionInfo(e.appid,"","",e.idName,"",PROTO_VERSION),null!=e.logUrl&&0!=e.logUrl.length&&this.logger.openLogServer(e.logUrl),this.configOK=!0,this.logger.debug("zc.p.c.0 call success"),!0):(this.logger.info("zc.p.c.0 fail"),!1)},ZegoClient.prototype.login=function(e,t,r,s,o){return this.logger.setSessionInfo(this.appid,e,"",this.idName,"",PROTO_VERSION),this.logger.info("zc.p.l.0 call:",e,r),this.configOK&&checkLoginParam({roomid:e,token:r})?(this.runState!==ENUM_RUN_STATE.logout&&(this.logger.debug("zc.p.l.0 reset"),setRunState(this,ENUM_RUN_STATE.logout),resetRoom(this)),this.logger.debug("zc.p.l.0 begin"),setRunState(this,ENUM_RUN_STATE.trylogin),this.roomid=e,this.token=r,this.role=t,registerCallback(this,"login",{success:s,error:o}),resetTryLogin(this),tryLogin(this),this.logger.info("zc.p.l.0 call success"),!0):(this.logger.info("zc.p.l.0 param error"),!1)},ZegoClient.prototype.logout=function(){return this.logger.debug("zc.p.l.1.0 call"),this.runState===ENUM_RUN_STATE.logout?(this.logger.info("zc.p.l.1.0 at logout"),!1):(this.playerCenter.reset(),setRunState(this,ENUM_RUN_STATE.logout),resetRoom(this),this.logger.debug("zc.p.l.1.0 call success"),!0)},ZegoClient.prototype.setUserStateUpdate=function(e){return this.logger.debug("zc.p.eusu.0 call"),"boolean"!=typeof e?(this.logger.info("zp.p.eusu.0 param error"),!1):(this.userStateUpdate=e,this.logger.debug("zc.p.eusu.0 call success "+e),!0)},ZegoClient.prototype.sendCustomCommand=function(e,t,r,s){if(this.logger.debug("zc.p.scc.0 call"),this.runState!==ENUM_RUN_STATE.login)return this.logger.info("zc.p.scc.0 state error"),!1;if(!(e&&e instanceof Array&&0!=e.length))return this.logger.info("zc.p.scc.0 dstMembers error"),!1;var o={dest_id_name:e,custom_msg:t};return checkCustomCommandParam(o)?(sendCustomMessage(this,"custommsg",o,r,s),this.logger.debug("zc.p.scc.0 call success"),!0):(this.logger.info("zc.p.scc.0 param error"),!1)},ZegoClient.prototype.sendRoomMsg=function(e,t,r,s,o){if(this.logger.debug("srm.0 call"),this.runState===ENUM_RUN_STATE.login){var i=Date.parse(new Date);if(this.sendRoomMsgTime>0&&this.sendRoomMsgTime+this.SendRoomMsgInterval>i)return this.logger.info("srm.0 freq error"),void(o&&o(sdkErrorList.FREQ_LIMITED,0,e,t,r));this.sendRoomMsgTime=i,this.logger.debug("srm.0 send fetch request"),sendCustomMessage(this,"im_chat",{msg_category:e,msg_type:t,msg_content:r},s,o),this.logger.debug("srm.0 call success")}else this.logger.info("srm.0 state error")},ZegoClient.prototype.startPlayingStream=function(e,t){return this.logger.debug("zc.p.sps.0 call"),this.playerCenter.updatePlayingState(e,t,!0),this.playerCenter.isPublishing()?this.preferPublishSourceType==ENUM_DISPATCH_TYPE.cdn?startPlayingStreamFromCDN(this,e):startPlayingStreamFromBGP(this,e):this.preferPlaySourceType==ENUM_PLAY_SOURCE_TYPE.ultra?startPlayingStreamFromBGP(this,e):startPlayingStreamFromCDN(this,e)},ZegoClient.prototype.stopPlayingStream=function(e){return this.logger.debug("zc.p.sps.1.0 call"),e&&""!==e?(this.playerCenter.stopPlayingStream(e),this.streamUrlMap[e]&&delete this.streamUrlMap[e],this.logger.debug("zc.p.sps.1.0 call success"),!0):(this.logger.info("zc.p.sps.1.0 param error"),!1)},ZegoClient.prototype.startPublishingStream=function(e,t,r){if(this.logger.debug("zc.p.sps.1 call"),!e||""===e)return this.logger.info("zc.p.sps.1 param error"),!1;if(this.publishStreamList[e]={state:ENUM_PUBLISH_STREAM_STATE.waiting_url,extra_info:r},this.logger.info("zc.p.sps.0 fetch stream url"),this.playerCenter.updatePublishingState(e,t,!0),fetchPublishStreamUrl(this,e),this.playerCenter.isPlaying()&&this.preferPublishSourceType==ENUM_PLAY_SOURCE_TYPE.ultra&&this.currentPlaySourceType==ENUM_DISPATCH_TYPE.cdn)for(var s=0;s<this.playerCenter.playingList.length;s++){var o=this.playerCenter.playingList[s].streamid,i=this.playerCenter.playingList[s].params;this.stopPlayingStream(o),this.playerCenter.updatePlayingState(o,i,!0),startPlayingStreamFromBGP(this,o)}return!0},ZegoClient.prototype.stopPublishingStream=function(e){return this.logger.debug("zc.p.sps.1.1 call"),e&&""!==e?(this.playerCenter.stopPublishingStream(e),this.publishStreamList[e]&&(this.publishStreamList[e].state>=ENUM_PUBLISH_STREAM_STATE.update_info&&updateStreamInfo(this,e,ENUM_STREAM_SUB_CMD.liveEnd),delete this.publishStreamList[e]),this.streamUrlMap[e]&&delete this.streamUrlMap[e],this.logger.debug("zc.p.sps.1.1 call success"),!0):(this.logger.info("zc.p.sps.1.1 param error"),!1)},ZegoClient.prototype.updateStreamExtraInfo=function(e,t){return this.logger.debug("zc.p.usei.0 call"),e&&""!==e?"string"==typeof t&&(this.publishStreamList[e]&&(this.publishStreamList[e].extra_info=t,this.publishStreamList[e].state>=ENUM_PUBLISH_STREAM_STATE.update_info&&updateStreamInfo(this,e,ENUM_STREAM_SUB_CMD.liveUpdate,t)),!0):(this.logger.info("zc.p.usei.0 param error"),!1)},ZegoClient.prototype.setPreferPlaySourceType=function(e){return this.logger.debug("zc.p.sppst.0 call"),"number"!=typeof e||e!==ENUM_PLAY_SOURCE_TYPE.auto&&e!==ENUM_PLAY_SOURCE_TYPE.ultra?(this.logger.info("zc.p.sppst.0 param error"),!1):(this.preferPlaySourceType=e,this.logger.debug("zc.p.sppst.0 call success"),!0)},ZegoClient.prototype.setPreferPublishSourceType=function(e){return this.logger.debug("zc.p.sppst.1 call"),"number"!=typeof e||e!==ENUM_DISPATCH_TYPE.cdn&&e!==ENUM_DISPATCH_TYPE.ultra?(this.logger.info("zc.p.sppst.1 param error"),!1):(this.preferPublishSourceType=e,this.logger.debug("zc.p.sppst.1 call success"),!0)},ZegoClient.prototype.release=function(){this.logger.debug("zc.p.r.0 call"),setRunState(this,ENUM_RUN_STATE.logout),resetRoom(this),this.playerCenter.reset(),this.logger.stopLogServer(),this.logger.debug("zc.p.r.0 call success")},ZegoClient.prototype.requestJoinLive=function(e,t,r,s){this.logger.debug("zc.p.rjl.0 call");var o=getRequestId(this),i=getSignalCmdContent(this,o,e);return null!=s&&(this.joinLiveCallbackMap[o]=s,sendSignalCmd(this,ENUM_SIGNAL_SUB_CMD.joinLiveRequest,i,e,t,r),!0)},ZegoClient.prototype.inviteJoinLive=function(e,t,r,s){this.logger.debug("zc.p.ijl.0 call");var o=getRequestId(this),i=getSignalCmdContent(this,o,e);return null!=s&&(this.joinLiveCallbackMap[o]=s,sendSignalCmd(this,ENUM_SIGNAL_SUB_CMD.joinLiveInvite,i,e,t,r),!0)},ZegoClient.prototype.respondJoinLive=function(e,t,r,s){this.logger.debug("zc.p.rjl.1 call");var o=this.joinLiveRequestMap[e];if(!o)return this.logger.info("zc.p.rjl.1 no dest id name"),!1;var i=0;!0===t&&(i=1);var a=getSignalCmdContent(this,e,o,i);return sendSignalCmd(this,ENUM_SIGNAL_SUB_CMD.joinLiveResult,a,o,r,s),delete this.joinLiveRequestMap[e],!0},ZegoClient.prototype.endJoinLive=function(e,t,r){this.logger.debug("zc.p.sjl.0 call");var s=getSignalCmdContent(this,getRequestId(this),e);return sendSignalCmd(this,ENUM_SIGNAL_SUB_CMD.joinLiveStop,s,e,t,r),!0},ZegoClient.prototype.updatePlayerState=function(e,t){this.logger.debug("zc.p.upe.0 call"),this.playerCenter.updatePlayerState(e,t)},ZegoClient.prototype.updatePlayerNetStatus=function(e,t){this.logger.debug("zc.p.upns.0 call"),this.playerCenter.updatePlayerNetStatus(e,t)},ZegoClient.prototype.sendReliableMessage=function(e,t,r,s){this.logger.debug("zc.p.srm.0 call"),this.transSeqMap[e]&&delete this.transSeqMap[e],this.transSeqMap[e]={seq:0},sendMessage(this,"trans",{trans_type:e,trans_data:t},r,s)},ZegoClient.prototype.sendRelayMessage=function(e,t,r,s){this.logger.debug("zc.p.srm.1 call");var o=this.datiTimeWindow,i=this.serverTimeOffset;o>0?(this.realyMessageList.push({type:e,data:t,success:r,error:s}),1==this.realyMessageList.length&&setRelayTimer(this,i,o)):sendRelayMessageInternal(this,e,t,r,s)},ZegoClient.prototype.sendBigRoomMessage=function(e,t,r,s,o){this.logger.debug("zc.p.sbim.1 call");var i=this.bigimTimeWindow,a=this.serverTimeOffset,n=(new Date).getTime()+a,l=++this.cmdSeq;if(l=l.toString(),null==s&&(s=null),null==o&&(o=null),this.bigImCallbackMap[l]={success:s,error:o},0==i){var g={msg_category:t,msg_type:e,msg_content:r,bigmsg_client_id:l};this.logger.debug("zc.p.sbim.1 no time window"),sendBigRoomMessageInternal(this,[g],handleBigImMsgRsp,o)}else{var u=Math.floor(n/i);if(this.logger.debug("currentIndex "+u+" lastTimeIndex "+this.bigImLastTimeIndex),this.bigImLastTimeIndex<u&&0==this.bigImMessageList.length)this.bigImLastTimeIndex=u,sendBigRoomMessageInternal(this,[{msg_category:t,msg_type:e,msg_content:r,bigmsg_client_id:l}],handleBigImMsgRsp,o);else this.bigImMessageList.push({msg_category:t,msg_type:e,msg_content:r,bigmsg_client_id:l}),1==this.bigImMessageList.length&&setBigImTimer(this,a,window)}};var sdkErrorList={SUCCESS:{code:"ZegoClient.Success",msg:"success."},PARAM:{code:"ZegoClient.Error.Param",msg:"input error."},HEARTBEAT_TIMEOUT:{code:"ZegoClient.Error.Timeout",msg:"heartbeat timeout."},LOGIN_TIMEOUT:{code:"ZegoClient.Error.Timeout",msg:"login timeout."},SEND_MSG_TIMEOUT:{code:"ZegoClient.Error.Timeout",msg:"send customsg timeout."},RESET_QUEUE:{code:"ZegoClient.Error.Timeout",msg:"msg waiting ack is clear when reset."},LOGIN_DISCONNECT:{code:"ZegoClient.Error.Network",msg:"network is broken and login fail."},KICK_OUT:{code:"ZegoClient.Error.Kickout",msg:"kickout reason="},UNKNOWN:{code:"ZegoClient.Error.Unknown",msg:"unknown error."},FREQ_LIMITED:{code:"ZegoClient.Error.requencyLimited",msg:"Frequency Limited."}};function setRunState(e,t){e.logger.debug("srs.0 old="+e.runState+", new="+t),e.lastRunState=e.runState,e.runState=t}function getHeader(e,t){return e.globalHeader={Protocol:"req",cmd:t,appid:e.appid,seq:++e.cmdSeq,user_id:e.userid,session_id:e.sessionid,room_id:e.roomid},e.globalHeader}function sendMessage(e,t,r,s,o){if(e.logger.debug("sm.0 call "+t),!e.websocket||1!==e.websocket.readyState)return e.logger.info("sm.0 error"),-1;var i=getHeader(e,t),a={header:i,body:r},n=JSON.stringify(a);if(null==s&&(s=null),null==o&&(o=null),null!=s||null!=o){var l={data:a,seq:i.seq,deleted:!1,time:Date.parse(new Date),success:s,error:o},g=e.sendCommandList.push(l);e.sendCommandMap[l.seq]=g}return e.websocket.send(n),e.logger.debug("sm.0 success"),i.seq}function sendCustomMessage(e,t,r,s,o){if(e.logger.debug("scm.0 call"),!e.websocket||1!==e.websocket.readyState)return e.logger.info("scm.0 error"),!1;var i=getHeader(e,t),a={header:i,body:r},n=JSON.stringify(a);null==s&&(s=null),null==o&&(o=null);var l={data:a,seq:i.seq,deleted:!1,time:Date.parse(new Date),success:s,error:o},g=e.sendDataList.push(l);return e.sendDataMap[l.seq]=g,e.websocket.send(n),e.logger.debug("scm.0 success seq: ",i.seq),!0}function checkMessageListTimeout(e,t,r){for(var s=t.getFirst(),o=Date.parse(new Date),i=0,a=0,n=0;!(null==s||s._data.time+e.sendDataTimeout>o||(delete r[s._data.data.header.seq],t.remove(s),++a,null==s._data.error||e.sendDataDropTimeout>0&&s._data.time+e.sendDataDropTimeout>o?++n:null!=s._data.data.body.custom_msg?s._data.error(sdkErrorList.SEND_MSG_TIMEOUT,s._data.data.header.seq,s._data.data.body.custom_msg):s._data.error(sdkErrorList.SEND_MSG_TIMEOUT,s._data.data.header.seq),++i>=e.sendDataCheckOnceCount));)s=t.getFirst();e.logger.debug("scmt.0 call success, stat: timeout=",a,"drop=",n)}function startCheckMessageTimeout(e){e.logger.debug("scmt.0 call"),e.runState===ENUM_RUN_STATE.login?(checkMessageListTimeout(e,e.sendDataList,e.sendDataMap),checkMessageListTimeout(e,e.sendCommandList,e.sendCommandMap),e.sendDataCheckTimer=setTimeout(function(){startCheckMessageTimeout(e)},e.sendDataCheckInterval)):e.logger.info("scmt.0 state error")}function checkSendMessageList(e){for(var t=e.getFirst();null!=t;)e.remove(t),null!=t._data.error&&(null!=t._data.data.body.custom_msg?t._data.error(sdkErrorList.SEND_MSG_TIMEOUT,t._data.data.header.seq,t._data.data.body.custom_msg):t._data.error(sdkErrorList.SEND_MSG_TIMEOUT,t._data.data.header.seq)),t=e.getFirst()}function resetCheckMessage(e){e.logger.debug("rcm.0 call"),clearTimeout(e.sendDataCheckTimer),e.sendDataCheckTimer=null,checkSendMessageList(e.sendDataList),checkSendMessageList(e.sendCommandList),e.sendDataMap={},e.sendCommandMap={},e.logger.debug("rcm.0 call success")}function resetBigRoomInfo(e){e.transSeqMap={},e.realyMessageList=[],e.relayTimer&&(clearTimeout(e.relayTimer),e.relayTimer=null),e.bigImLastTimeIndex=0,e.bigIMmessageList=[],e.bigImCallbackMap={},e.bigImTimer&&(clearTimeout(e.bigImTimer),e.bigImTimer=null),e.serverTimeOffset=0,e.datiTimeWindow=0,e.bigimTimeWindow=0}function resetHeartbeat(e){e.logger.debug("rht.0 call"),clearTimeout(e.heartbeatTimer),e.heartbeatTimer=null,e.tryHeartbeatCount=0,e.logger.debug("rht.0 call success")}function startHeartbeat(e){if(e.logger.debug("sht.0 call"),e.runState===ENUM_RUN_STATE.login){if(++e.tryHeartbeatCount>MAX_TRY_HEARTBEAT_COUNT)return e.logger.error("sht.0 come to try limit"),setRunState(e,ENUM_RUN_STATE.logout),resetRoom(e),void e.onDisconnect(sdkErrorList.HEARTBEAT_TIMEOUT);e.logger.debug("sht.0 send packet");sendMessage(e,"hb",{reserve:0}),e.heartbeatTimer=setTimeout(function(){startHeartbeat(e)},e.heartbeatInterval),e.logger.debug("sht.0 call success")}else e.logger.info("sht.0 state error")}function resetTryLogin(e){e.logger.debug("rtl.0 call"),clearTimeout(e.tryLoginTimer),e.tryLoginTimer=null,e.tryLoginCount=0,e.logger.debug("rtl.0 call success")}function tryLogin(e){if(e.logger.debug("tl.0 call"),e.runState===ENUM_RUN_STATE.trylogin){if(++e.tryLoginCount>MAX_TRY_LOGIN_COUNT){e.logger.error("tl.0 fail times limit");var t=e.lastRunState;return setRunState(e,ENUM_RUN_STATE.logout),resetRoom(e),void(t==ENUM_RUN_STATE.login?(e.logger.info("tl.0 fail and disconnect"),e.onDisconnect(sdkErrorList.LOGIN_DISCONNECT)):(e.logger.info("tl.0 fail and callback user"),actionErrorCallback(e,"login")(sdkErrorList.LOGIN_TIMEOUT)))}if(e.websocket&&1===e.websocket.readyState){e.logger.info("tl.0 use current websocket and sent login");var r=loginBodyData(e);sendMessage(e,"login",r)}else{e.logger.debug("tl.0 need new websocket");try{e.websocket&&(e.logger.info("tl.0 close error websocket"),e.websocket.onclose=null,e.websocket.onerror=null,e.websocket.close(),e.websocket=null),e.logger.debug("tl.0 new websocket"),e.websocket=new ZegoWebSocket(e.server),e.websocket.onopen=function(){e.logger.info("tl.0 websocket.onpen call"),bindWebSocketHandler(e),e.logger.info("tl.0 websocket.onpen send login");var t=loginBodyData(e);sendMessage(e,"login",t),e.logger.debug("tl.0 websocket.onpen call success")}}catch(t){e.logger.error("tl.0 websocket err:"+t)}}e.tryLoginTimer=setTimeout(function(){tryLogin(e)},TRY_LOGIN_INTERVAL[e.tryLoginCount%MAX_TRY_LOGIN_COUNT]),e.logger.debug("tl.0 call success")}else e.logger.info("tl.0 state error")}function loginBodyData(e){return{id_name:e.idName,nick_name:e.nickName,role:e.role,token:e.token,version:PROTO_VERSION,user_state_flag:e.userStateUpdate?1:0,room_create_flag:e.roomCreateFlag}}function resetRoom(e){if(e.logger.debug("rr.0 call"),resetTryLogin(e),resetHeartbeat(e),resetCheckMessage(e),e.streamList=[],e.publishStreamList={},e.streamQuerying=!1,e.joinLiveCallbackMap={},e.joinLiveRequestMap={},e.streamUrlMap={},resetBigRoomInfo(e),e.logger.debug("rr.0 call send logout=",e.sessionid),"0"!==e.sessionid){sendMessage(e,"logout",{reserve:0})}e.websocket&&(e.websocket.onclose=null,e.websocket.onerror=null,e.websocket.close(),e.websocket=null),e.userid="0",e.sessionid="0",e.logger.setSessionInfo(e.appid,e.roomid,e.userid,e.idName,e.sessionid,PROTO_VERSION),e.logger.debug("rr.0 call success")}function fetchStreamList(e){if(e.logger.debug("fsl.0 call"),e.runState===ENUM_RUN_STATE.login)if(e.streamQuerying)e.logger.info("fsl.0 already doing");else{e.streamQuerying=!0,e.logger.debug("fsl.0 send fetch request");sendMessage(e,"stream_info",{reserve:0}),e.logger.debug("fsl.0 call success")}else e.logger.info("fsl.0 state error")}function fetchUserList(e){e.logger.debug("ful.0 call"),e.userQuerying?e.logger.info("ful.0 is already querying"):(e.userQuerying=!0,e.userTempList=[],fetchUserListWithPage(e,0),e.logger.debug("ful.0 the first time call"))}function fetchUserListWithPage(e,t){e.logger.debug("fulwp.0 call"),sendMessage(e,"user_list",{user_index:t,sort_type:0}),e.logger.debug("fulwp.0 call success")}function fetchPlayStreamUrl(e,t){if(e.logger.debug("fsu.0 call"),e.runState===ENUM_RUN_STATE.login){e.logger.info("fsu.0 send fetch request");var r=sendMessage(e,"stream_url",{stream_ids:[t],url_type:e.ultraPlaySourceType});-1==r?e.onPlayStateUpdate(1,t,-1):e.streamUrlMap[r]=t,e.logger.debug("fsu.0 call success")}else e.logger.info("fsu.0 state error")}function fetchPublishStreamUrl(e,t){if(e.logger.debug("fpsu.0 call"),e.runState===ENUM_RUN_STATE.login){e.logger.info("fpsu.0 send fetch publish request");var r="";e.preferPublishSourceType==ENUM_DISPATCH_TYPE.cdn?r="cdn":e.preferPublishSourceType==ENUM_DISPATCH_TYPE.ultra&&(r="bgp");var s=sendMessage(e,"stream_publish",{stream_id:t,url_type:e.ultraPlaySourceType,publish_type:r});-1==s?e.onPublishStateUpdate(1,t,-1):e.streamUrlMap[s]=t,e.logger.debug("fpsu.0 call success")}else e.logger.info("fpsu.0 state error")}function isKeepTryLogin(e){switch(e){case 1002:case 1003:return!0;default:return!1}}function sendSignalCmd(e,t,r,s,o,i){(e.logger.debug("ssc.0 call"),e.runState===ENUM_RUN_STATE.login)?(e.logger.debug("ssc.0 send signal cmd "+t),sendMessage(e,"signal",{sub_cmd:t,signal_msg:r,dest_id_name:[s]},o,i),e.logger.debug("ssc.0 call success")):e.logger.info("ssc.0 state error")}function getRequestId(e){return++e.cmdSeq,e.idName+"-"+e.cmdSeq}function getSignalCmdContent(e,t,r,s){var o={request_id:t,room_id:e.roomid,from_userid:e.idName,from_username:e.nickName,to_userid:r};return null!=s&&(o.result=s),JSON.stringify(o)}function updateStreamInfo(e,t,r,s){e.logger.debug("usi.0 call");var o="";null!=s&&"string"==typeof s&&(o=s);var i={stream_id:t,extra_info:o},a=JSON.stringify(i);sendMessage(e,"stream",{sub_cmd:r,stream_msg:a},void 0,function(s){e.publishStreamList[t]&&r==ENUM_STREAM_SUB_CMD.liveBegin&&(e.publishStreamList[t].state=ENUM_PUBLISH_STREAM_STATE.stop,e.onPublishStateUpdate(1,t,s))}),e.logger.debug("usi.0 call success cmd "+r)}function fetchReliableMessage(e,t,r){e.logger.debug("frm.0 call"),sendMessage(e,"trans_fetch",{trans_type:t,trans_local_seq:r}),e.logger.debug("frm.0 call success")}function sendRelayMessageInternal(e,t,r,s,o){e.logger.debug("srm.0 call"),sendMessage(e,"relay",{relay_type:t,relay_data:r},s,o)}function setRelayTimer(e,t,r){var s=generateRandumNumber(2*r-((new Date).getTime()+t)%r);e.logger.info("srt.0 setTimer "+s),e.relayTimer=setTimeout(function(){onRelayTimer(e)},s)}function onRelayTimer(e){if(0!=e.realyMessageList.length){var t=e.realyMessageList[0];sendRelayMessageInternal(e,t.type,t.data,t.success,t.error),clearTimeout(e.relayTimer),e.relayTimer=null,e.realyMessageList.splice(0,1),e.realyMessageList.length>0&&setRelayTimer(e,e.serverTimeOffset,e.datiTimeWindow)}else e.logger.info("ort.0 no relay data")}function sendBigRoomMessageInternal(e,t,r,s){e.logger.debug("sbim.0 call"),sendMessage(e,"bigim_chat",{msgs:t},r,s)}function setBigImTimer(e,t,r){var s=r-((new Date).getTime()+t)%r,o=generateRandumNumber(r)+s;e.logger.info("sbt.0 setTimer "+o),e.bigImTimer=setTimeout(function(){onBigImTimer(e)},o)}function onBigImTimer(e){var t=(new Date).getTime()+e.serverTimeOffset;e.bigImLastTimeIndex=Math.floor(t/e.bigimTimeWindow);for(var r=[],s=[],o=0;o<e.bigImMessageList.length&&!(o>=20);o++){var i=e.bigImMessageList[o];r.push({msg_category:i.msg_category,msg_type:i.msg_type,msg_content:i.msg_content,bigmsg_client_id:i.bigmsg_client_id}),s.push(i.bigmsg_client_id)}e.bigImMessageList.length>20?e.bigImMessageList.splice(0,20):e.bigImMessageList=[],sendBigRoomMessageInternal(e,r,handleBigImMsgRsp,function(t,r){for(var o=0;o<s.length;o++){var i=s[o],a=e.bigImCallbackMap[i];a&&(null!=a.error&&a.error(t,r),delete e.bigImCallbackMap[i])}}),clearTimeout(e.bigImTimer),e.bigImTimer=null,e.bigImMessageList.length>0&&setBigImTimer(e,e.serverTimeOffset,e.bigimTimeWindow)}function generateRandumNumber(e){return parseInt(Math.random()*(e+1),10)}function handleLoginFail(e,t){if(e.logger.debug("hlf.0 call"),isKeepTryLogin(t.body.err_code))e.logger.info("hlf.0 KeepTry true");else{var r=e.lastRunState;setRunState(e,ENUM_RUN_STATE.logout),resetRoom(e);var s=getServerError(t.body.err_code);r==ENUM_RUN_STATE.login?(e.logger.info("hlf.0 callback disconnect"),e.onDisconnect(s)):(e.logger.info("hlf.0 callback error"),actionErrorCallback(e,"login")(s)),e.logger.debug("hlf.0 call success")}}function handleLoginSuccess(e,t){e.logger.debug("hls.0 call");var r=e.lastRunState;if(setRunState(e,ENUM_RUN_STATE.login),e.userid=t.body.user_id,e.sessionid=t.body.session_id,e.logger.setSessionInfo(e.appid,e.roomid,e.userid,e.idName,e.sessionid,PROTO_VERSION),null!=t.body.config_info&&(e.logger.setRemoteLogLevel(t.body.config_info.log_level),""!=t.body.config_info.log_url&&e.logger.openLogServer(t.body.config_info.log_url)),null!=t.body.ret_timestamp&&"string"==typeof t.body.ret_timestamp){var s=parseFloat(t.body.ret_timestamp);e.serverTimeOffset=0==s?0:t.body.ret_timestamp-(new Date).getTime()}if(null!=t.body.bigim_time_window&&"number"==typeof t.body.bigim_time_window&&(e.bigimTimeWindow=t.body.bigim_time_window),null!=t.body.dati_time_window&&"number"==typeof t.body.dati_time_window&&(e.datiTimeWindow=t.body.dati_time_window),resetTryLogin(e),resetHeartbeat(e),e.heartbeatInterval=t.body.hearbeat_interval,e.heartbeatInterval<MINIUM_HEARTBEAT_INTERVAL&&(e.heartbeatInterval=MINIUM_HEARTBEAT_INTERVAL),e.heartbeatTimer=setTimeout(function(){startHeartbeat(e)},e.heartbeatInterval),resetCheckMessage(e),e.sendDataCheckTimer=setTimeout(function(){startCheckMessageTimeout(e)},e.sendDataCheckInterval),e.streamQuerying=!1,r==ENUM_RUN_STATE.login)e.logger.info("hls.0 recover from disconnect so call streamupdate"),handleFullUpdateStream(e,t.body.stream_seq,t.body.stream_info||[]);else{e.logger.info("hls.0 success callback user"),e.streamList=t.body.stream_info||[],e.streamSeq=t.body.stream_seq;for(var o=0;o<e.streamList.length;o++)e.streamList[o].anchor_id_name==e.idName&&(updateStreamInfo(e,e.streamList[o].stream_id,ENUM_STREAM_SUB_CMD.liveEnd),e.streamList.splice(o,1));var i;i=makeCallbackStreamList(e.streamList),actionSuccessCallback(e,"login")(i)}if(t.body.anchor_info){var a=t.body.anchor_info.anchor_id_name,n=t.body.anchor_info.anchor_nick_name;e.onGetAnchorInfo(a,n)}e.logger.debug("hls.0 userStateUpdate "+e.userStateUpdate),e.userStateUpdate&&(e.logger.info("hls.0 fetch all new userlist"),fetchUserList(e)),e.logger.debug("hls.0 call success")}function handleLoginRsp(e,t){if(e.logger.debug("hlr.0 call"),e.runState===ENUM_RUN_STATE.trylogin)if(t.header.seq===e.cmdSeq){if(0!==t.body.err_code)return handleLoginFail(e,t),void e.logger.info("hlr.0 server error=",t.body.err_code);handleLoginSuccess(e,t),e.logger.info("hlr.0 call success.")}else e.logger.info("hlr.0 in wrong seq, local=",e.cmdSeq,",recv=",t.header.seq);else e.logger.info("hlr.0 state error")}function handleHeartbeatRsp(e,t){if(e.logger.debug("hhbr.0 call"),0===t.body.err_code){if(e.tryHeartbeatCount=0,e.heartbeatInterval=t.body.hearbeat_interval,e.heartbeatInterval<MINIUM_HEARTBEAT_INTERVAL&&(e.heartbeatInterval=MINIUM_HEARTBEAT_INTERVAL),null!=t.body.bigim_time_window&&"number"==typeof t.body.bigim_time_window&&(e.bigimTimeWindow=t.body.bigim_time_window),null!=t.body.dati_time_window&&"number"==typeof t.body.dati_time_window&&(e.datiTimeWindow=t.body.dati_time_window),null!=t.body.trans_seqs)for(var r=0;r<t.body.trans_seqs.length;r++){var s=t.body.trans_seqs[r].trans_type,o=t.body.trans_seqs[r].trans_seq;if(!e.transSeqMap[s]||e.transSeqMap[s].seq!==o){var i=0;e.transSeqMap[s]?(i=e.transSeqMap[s].seq,e.logger.debug("hhbr.0 type "+s+" old seq "+e.transSeqMap[s].seq+" server seq "+o)):(i=0,e.logger.debug("hhbr.0 type "+s+" server seq "+o)),fetchReliableMessage(e,s,i)}}for(var a in t.body.stream_seq!==e.streamSeq&&(e.logger.debug("hhbr.0 current seq "+e.streamSeq+" server Seq "+t.body.stream_seq),fetchStreamList(e)),t.body.server_user_seq!==e.userSeq&&e.userStateUpdate&&(e.logger.info("hhbr.0 call update user "+t.body.server_user_seq,e.userSeq),fetchUserList(e)),e.publishStreamList)e.publishStreamList[a].state==ENUM_PUBLISH_STREAM_STATE.update_info&&(e.logger.info("hbbr.0 try to update stream info"),updateStreamInfo(e,a,ENUM_STREAM_SUB_CMD.liveBegin,e.publishStreamList[a].extra_info));e.logger.debug("hhbr.0 call success")}else{e.logger.info("hhbr.0 call disconnect, server error=",t.body.err_code),setRunState(e,ENUM_RUN_STATE.logout),resetRoom(e);var n=getServerError(t.body.err_code);e.onDisconnect(n)}}function handleLogoutRsp(e,t){e.logger.debug("hlor.0 result=",t.body.err_code)}function handleSendCustomMsgRsp(e,t){e.logger.debug("hscmr.0 call");var r,s=e.sendDataMap[t.header.seq];null!=s?("custommsg"!=(r=s._data).data.header.cmd?e.logger.error("hscmr.0 cmd wrong"+r.data.header.cmd):0===t.body.err_code?null!=r.success&&r.success(t.header.seq,r.data.body.custom_msg):null!=r.error&&r.error(getServerError(t.body.err_code),t.header.seq,r.data.body.custom_msg),delete e.sendDataMap[t.header.seq],e.sendDataList.remove(s)):e.logger.error("hscmr.0 no found seq="+t.header.seq),e.logger.debug("hscmr.0 call success")}function handleSendCommandMsgRsp(e,t){e.logger.debug("hscmr.0 call");var r,s=e.sendCommandMap[t.header.seq];null!=s&&("login"==(r=s._data).data.header.cmd?e.logger.debug("hscmr.0 don't check "+r.data.header.cmd):"relay"==r.data.header.cmd?0===t.body.err_code?null!=r.success&&r.success(t.header.seq,t.body.relay_result):null!=r.error&&r.error(getServerError(t.body.err_code),t.header.seq):"bigim_chat"==r.data.header.cmd?0===t.body.err_code&&(null!=r.success?handleBigImMsgRsp(e,t):null!=r.error&&r.error(getServerError(t.body.err_code),t.header.seq)):0===t.body.err_code?null!=r.success&&r.success(t.header.seq):null!=r.error&&r.error(getServerError(t.body.err_code),t.header.seq),delete e.sendCommandMap[t.header.seq],e.sendCommandList.remove(s)),e.logger.debug("hscmr.0 call success")}function handleSendRoomMsgRsp(e,t){e.logger.debug("hsrmr.0 call");var r,s=e.sendDataMap[t.header.seq];null!=s?("im_chat"!=(r=s._data).data.header.cmd?e.logger.error("hsrmr.0 cmd wrong"+r.data.header.cmd):0===t.body.err_code?r.success&&r.success(t.header.seq,t.body.msg_id,r.data.body.msg_category,r.data.body.msg_type,r.data.body.msg_content):r.error&&r.error(getServerError(t.body.err_code),t.header.seq,r.data.body.msg_category,r.data.body.msg_type,r.data.body.msg_content),delete e.sendDataMap[t.header.seq],e.sendDataList.remove(s)):e.logger.error("hsrmr.0 no found seq="+t.header.seq),e.logger.debug("hsrmr.0 call success")}function handlePushCustomMsg(e,t){var r=JSON.parse(t.body.custommsg);e.logger.debug("hpcm.0 submsg=",r),e.onRecvCustomCommand(r.from_userid,r.from_username,r.custom_content)}function handlePushRoomMsg(e,t){e.onRecvRoomMsg(t.body.chat_data,t.body.server_msg_id,t.body.ret_msg_id)}function handleFullUpdateStream(e,t,r){e.logger.debug("hfus.0 call"),e.streamSeq=t,e.logger.debug("hfus.0 server seq "+e.streamSeq),mergeStreamList(e,e.streamList,r,function(t,r,s){0!==t.length&&(e.logger.debug("hfus.0 callback addstream"),e.onStreamUpdated(ENUM_STREAM_UPDATE_TYPE.added,makeCallbackStreamList(t))),0!==r.length&&(e.logger.debug("hfus.0 callback delstream"),e.onStreamUpdated(ENUM_STREAM_UPDATE_TYPE.deleted,makeCallbackStreamList(r))),0!==s.length&&(e.logger.debug("hfus.0 callback updatestream"),e.onStreamExtraInfoUpdated(makeCallbackStreamList(s)))}),e.logger.debug("hfus.0 call success")}function mergeStreamList(e,t,r,s){e.logger.debug("msl.0 call");for(var o,i=[],a=[],n=[],l=0;l<r.length;l++)if(r[l].anchor_id_name!=e.idName){o=!1;for(var g=0;g<t.length;g++)if(r[l].stream_id===t[g].stream_id){r[l].extra_info!==t[g].extra_info&&n.push(r[l]),o=!0;break}o||i.push(r[l])}else e.logger.debug("msl.0 have self stream added");for(var u=0;u<t.length;u++){o=!1;for(var d=0;d<r.length;d++)if(r[d].anchor_id_name!=e.idName){if(t[u].stream_id===r[d].stream_id){o=!0;break}}else e.logger.debug("msl.0 have self stream deleted");o||a.push(t[u])}t=r,s(i,a,n),e.logger.debug("msl.0 call success")}function makeCallbackStreamList(e){var t=[];if(null!=e&&null!=e)for(var r=0;r<e.length;r++)t.push({anchor_id_name:e[r].anchor_id_name,stream_gid:e[r].stream_gid,anchor_nick_name:e[r].anchor_nick_name,extra_info:e[r].extra_info,stream_id:e[r].stream_id});return t}function handleFetchStreamListRsp(e,t){e.logger.debug("hfslr.0 call"),e.streamQuerying=!1,0===t.body.err_code?e.streamSeq!==t.body.stream_seq?(handleFullUpdateStream(e,t.body.stream_seq,t.body.stream_info),e.logger.debug("hfslr.0 call success")):e.logger.info("hfslr.0 same seq"):e.logger.info("hfslr.0 server error=",t.body.err_code)}function handleFetchStreamUrlRsp(e,t){e.logger.debug("hfsur.0 call");var r=e.streamUrlMap[t.header.seq];if(r&&delete e.streamUrlMap[t.header.seq],0!==t.body.err_code)return e.logger.debug("hfsur.0 server error=",t.body.err_code),void e.onPlayStateUpdate(1,r,t.body.err_code);if(t.body.stream_url_infos&&t.body.stream_url_infos.length>0){for(var s=t.body.stream_url_infos[0].stream_id,o=t.body.stream_url_infos[0].urls_ws,i=!1,a=0;a<e.streamList.length;a++)if(e.streamList[a].stream_id==s){e.streamList[a].urltra_url_rtmp=o,i=!0;break}i||e.streamList.push({stream_id:s,urltra_url_rtmp:o}),doPlayStream(e,s,o)}e.logger.debug("hfsur.0 call success")}function handleFetchStreamPublishUrlRsp(e,t){e.logger.debug("hfspur.0 call");var r=e.streamUrlMap[t.header.seq];if(r&&delete e.streamUrlMap[t.header.seq],0!==t.body.err_code)return e.logger.info("hfspur.0 server error=",t.body.err_code),void(e.publishStreamList[r]&&e.onPublishStateUpdate(1,r,t.body.err_code));if(t.body.stream_url_info){var s=t.body.stream_url_info.stream_id,o=t.body.stream_url_info.urls_ws;if(!e.publishStreamList[s])return void e.logger.info("hfspur.0 cannot find stream");e.publishStreamList[s].url_rtmp=o,e.publishStreamList[s].state=ENUM_PUBLISH_STREAM_STATE.tryPublish,doPublishStream(e,s,o)}}function handleAddedStreamList(e,t){e.logger.debug("hasl.0 call");for(var r,s=[],o=0;o<t.length;o++)if(t[o].anchor_id_name!=e.idName){r=!1;for(var i=0;i<e.streamList.length;i++)if(t[o].stream_id===e.streamList[i].stream_id){r=!0;break}r||s.push(t[o])}else e.logger.debug("hdsl.0 have self stream added");0!==s.length&&(e.logger.debug("hasl.0 callback addstream"),e.streamList.concat(s),e.onStreamUpdated(ENUM_STREAM_UPDATE_TYPE.added,makeCallbackStreamList(s))),e.logger.debug("hasl.0 call success")}function handleDeletedStreamList(e,t){e.logger.debug("hdsl.0 call");for(var r=[],s=0;s<t.length;s++)if(t[s].anchor_id_name!=e.idName){for(var o=e.streamList.length-1;o>=0;o--)if(t[s].stream_id===e.streamList[o].stream_id){e.streamList.splice(o,1),r.push(t[s]);break}}else e.logger.debug("hdsl.0 have self stream deleted");0!==r.length&&(e.logger.debug("hdsl.0 callback delstream"),e.onStreamUpdated(ENUM_STREAM_UPDATE_TYPE.deleted,makeCallbackStreamList(r))),e.logger.debug("hdsl.0 call")}function handleUpdatedStreamList(e,t){e.logger.debug("husl.0 call");for(var r=[],s=0;s<t.length;s++)if(t[s].anchor_id_name!=e.idName){for(var o=0;o<e.streamList.length;o++)if(t[s].stream_id===e.streamList[o].stream_id){t[s].extra_info!==e.streamList[o].extra_info&&(e.streamList[o]=t[s],r.push(t[s]));break}}else e.logger.debug("hsul.0 have self stream updated");0!==r.length&&(e.logger.debug("husl.0 callback updatestream"),e.onStreamExtraInfoUpdated(makeCallbackStreamList(r))),e.logger.debug("husl.0 call success")}function handlePushStreamUpdateMsg(e,t){if(e.logger.debug("hpsum.0 call"),t.body.stream_info&&0!==t.body.stream_info.length){if(t.body.stream_info.length+e.streamSeq!==t.body.stream_seq)return e.logger.info("hpsum.0 call updatestream"),void fetchStreamList(e);switch(e.streamSeq=t.body.stream_seq,t.body.stream_cmd){case ENUM_STREAM_UPDATE_CMD.added:handleAddedStreamList(e,t.body.stream_info);break;case ENUM_STREAM_UPDATE_CMD.deleted:handleDeletedStreamList(e,t.body.stream_info);break;case ENUM_STREAM_UPDATE_CMD.updated:handleUpdatedStreamList(e,t.body.stream_info)}e.logger.debug("hpsum.0 call success")}else e.logger.info("hpsum.0, emtpy list")}function handlePushKickout(e,t){e.logger.info("hpk.0 call"),setRunState(e,ENUM_RUN_STATE.logout),resetRoom(e);var r={code:sdkErrorList.KICK_OUT.code,msg:sdkErrorList.KICK_OUT.msg+t.body.reason};e.onKickOut(r),e.logger.debug("hpk.0 call success")}function handlePushUserStateUpdateMsg(e,t){if(e.logger.debug("hpus.0 call"),e.runState==ENUM_RUN_STATE.login)if(e.userStateUpdate){if(e.userSeq+t.body.user_actions.length!==t.body.user_list_seq)return e.logger.info("hpus.0 fetch new userlist "+e.userSeq,NaN+t.body.user_list_seq),void fetchUserList(e);e.userSeq=t.body.user_list_seq,e.logger.debug("hpus.0 push userSeq "+e.userSeq);for(var r=[],s=0;s<t.body.user_actions.length;s++){var o={action:t.body.user_actions[s].Action,idName:t.body.user_actions[s].IdName,nickName:t.body.user_actions[s].NickName,role:t.body.user_actions[s].Role,loginTime:t.body.user_actions[s].LoginTime};r.push(o)}e.onUserStateUpdate(t.body.room_id,r),e.logger.debug("hpus.0 call success")}else e.logger.info("hpus.0 no userStateUpdate flag");else e.logger.info("hpus.0 not login")}function handleFetchUserListRsp(e,t){if(e.logger.debug("hfulr.0 call"),0!=t.body.err_code)return e.userQuerying=!1,void e.logger.info("hfulr.0 fetch error "+t.body.err_code);if(e.userStateUpdate){e.userTempList.push.apply(e.userTempList,t.body.user_baseinfos);var r=t.body.ret_user_index;if(r!=t.body.server_user_index)return e.logger.info("hfulr.0 fetch another page"),void fetchUserListWithPage(r+1);e.userSeq=t.body.server_user_seq,e.logger.info("hfulr.0 set user Seq "+e.userSeq);for(var s=[],o=0;o<e.userTempList.length;o++){var i={idName:e.userTempList[o].id_name,nickName:e.userTempList[o].nick_name,role:e.userTempList[o].role};s.push(i)}e.userQuerying=!1,e.onGetTotalUserList(e.roomid,s),e.userTempList=[],e.logger.debug("hfulr.0 call success user_list "+s+" count "+s.length)}}function handlePushSignalMsg(e,t){if(e.runState==ENUM_RUN_STATE.login){var r=JSON.parse(t.body.signal_msg);switch(e.logger.debug("hpcm.0 submsg= ",r),t.body.sub_cmd){case ENUM_PUSH_SIGNAL_SUB_CMD.pushJoinLiveRequest:handlePushJoinLiveRequestMsg(e,r);break;case ENUM_PUSH_SIGNAL_SUB_CMD.pushJoinLiveResult:handlePushJoinLiveResultMsg(e,r);break;case ENUM_PUSH_SIGNAL_SUB_CMD.pushJoinLiveInvite:handlePushJoinLiveInviteMsg(e,r);break;case ENUM_PUSH_SIGNAL_SUB_CMD.pushJoinLiveStop:handlePushJoinLiveStopMsg(e,r)}e.logger.debug("hpsm.0 call end")}else e.logger.info("hpcm.0 not login")}function handlePushJoinLiveRequestMsg(e,t){var r=t.request_id;if("string"==typeof r){var s=t.from_userid;"string"==typeof s?(e.joinLiveRequestMap[r]=s,e.logger.info("hpjlrm.0 onRecvJoinLiveRequest "+s),e.onRecvJoinLiveRequest(r,t.from_userid,t.from_username,t.room_id)):e.logger.error("hpjlrm.0 no from user")}else e.logger.error("hpjlrm.0 no requestId")}function handlePushJoinLiveInviteMsg(e,t){var r=t.request_id;if("string"==typeof r){var s=t.from_userid;"string"==typeof s?(e.joinLiveRequestMap[r]=s,e.logger.info("hpjlim.0 onRecvInviteJoinLiveRequest "+s),e.onRecvInviteJoinLiveRequest(r,t.from_userid,t.from_username,t.room_id)):e.logger.error("hpjlim.0 no from user")}else e.logger.error("hpjlim.0 no requestId")}function handlePushJoinLiveResultMsg(e,t){var r=t.request_id;if("string"==typeof r){var s=t.result;if(null!=s){var o=1==s;if(e.joinLiveCallbackMap[r]){var i=e.joinLiveCallbackMap[r];if(!i)return void e.logger.info("hpjlrm.o no callback");e.logger.info("hpjlrm.0 joinLiveRequest/invite result "+o),delete e.joinLiveCallbackMap[r],i(o,t.from_userid,t.from_username)}}else e.logger.info("hpjlrm.0 no result")}else e.logger.error("hpjlrm.0 no requestId")}function handlePushJoinLiveStopMsg(e,t){var r=t.request_id;"string"==typeof r?(e.logger.info("hpjlsm.0 onRecvEndJoinLiveCommand "+t.from_userid),e.onRecvEndJoinLiveCommand(r,t.from_userid,t.from_username,t.room_id)):e.logger.error("hpjlsm.0 no requestId")}function handleStreamUpdateRsp(e,t){if(e.runState==ENUM_RUN_STATE.login)if(0==t.body.err_code){e.logger.debug("hsur.0 stream seq "+e.streamSeq+" server seq "+t.body.stream_seq),e.streamSeq=t.body.stream_seq;for(var r=0;r<t.body.stream_info.length;r++){var s=t.body.stream_info[r].stream_id;if(!e.publishStreamList[s])return void e.logger.info("hsur.0 stream is not exist");e.publishStreamList[s].state==ENUM_PUBLISH_STREAM_STATE.update_info&&(e.publishStreamList[s].state=ENUM_PUBLISH_STREAM_STATE.publishing,e.onPublishStateUpdate(0,s,0))}}else e.logger.info("hsur.0 stream update error "+t.body.err_code);else e.logger.info("hsur.0 not login")}function handleTransRsp(e,t){if(e.runState==ENUM_RUN_STATE.login)if(0==t.body.err_code){var r=t.body.trans_type;e.transSeqMap[r]?(e.transSeqMap[r].seq=t.body.trans_seq,e.logger.debug("htr.0 trans "+r+" seq "+t.body.trans_seq)):e.logger.info("htr.0 cannot match send info")}else e.logger.info("htr.0 trans send error "+t.body.err_code);else e.logger.info("htr.0 not login")}function handleFetchTransRsp(e,t){if(e.runState==ENUM_RUN_STATE.login)if(0==t.body.err_code){var r=t.body.trans_type,s=t.body.trans_seq;e.transSeqMap[r]?e.transSeqMap[r].seq=s:e.transSeqMap[r]={seq:s},t.body.trans_user_idname!=e.idName&&e.onRecvReliableMessage(r,s,t.body.trans_data),e.logger.debug("hftr.0 trans "+r+" seq "+s)}else e.logger.info("hftr.0 trans send error "+t.body.err_code);else e.logger.info("hftr.0 not login")}function handlePushTransMsg(e,t){if(e.runState==ENUM_RUN_STATE.login){var r=t.body.trans_type,s=t.body.trans_seq;e.transSeqMap[r]?e.transSeqMap[r].seq=s:e.transSeqMap[r]={seq:s},t.body.trans_user_idname!=e.idName?e.onRecvReliableMessage(r,s,t.body.trans_data):e.logger.debug("hptr.0 receive self trans message"),e.logger.debug("hptr.0 trans "+r+" seq "+s)}else e.logger.info("hptr.0 not login")}function handlePushMergeMsg(e,t){if(e.runState==ENUM_RUN_STATE.login){for(var r=0;r<t.body.messages.length;r++)14001===t.body.messages[r].sub_cmd&&handlePushBigRooMsg(e,t.body.messages[r].msg_body);e.logger.debug("hpmm.0 call success")}else e.logger.info("hpmm.0 not login")}function handlePushBigRooMsg(e,t){try{var r=JSON.parse(t)}catch(t){return void e.logger.warn("hpbrm.0 parse json error")}if(null!=r){for(var s=r.room_id,o=[],i=0;i<r.msg_data.length;i++){var a=r.msg_data[i];a.id_name!=e.idName?o.push({idName:a.id_name,nickName:a.nick_name,messageId:a.bigmsg_id,category:a.msg_category,type:a.msg_type,content:a.msg_content,time:a.send_time}):e.logger.debug("hpbrm.0 self message")}0==o.length?e.logger.debug("hpbrm.0 no other pushData except self"):e.onRecvBigRoomMessage(o,s),e.logger.debug("hpbrm.0 call success")}else e.logger.warn("hpbrm.0 cann't find message body")}function handleBigImMsgRsp(e,t){if(e.runState==ENUM_RUN_STATE.login){e.bigimTimeWindow!=t.body.bigim_time_window&&(e.bigimTimeWindow=t.body.bigim_time_window);for(var r=0;r<t.body.msgs.length;r++){var s=t.body.msgs[r].bigmsg_client_id,o=t.body.msgs[r].bigmsg_id;if(e.bigImCallbackMap[s]){var i=e.bigImCallbackMap[s].success;null!=i&&i(t.header.seq,o),delete e.bigImCallbackMap[s]}}}else e.logger.info("hbmr.0 not login")}function bindWebSocketHandler(e){e.websocket.onmessage=function(t){var r=JSON.parse(t.data);if(e.logger.debug("jsonmsg= ",r.header.cmd),"login"!==r.header.cmd)if(r.header.appid===e.appid&&r.header.session_id===e.sessionid&&r.header.user_id===e.userid&&r.header.room_id===e.roomid&&e.runState===ENUM_RUN_STATE.login)switch(handleSendCommandMsgRsp(e,r),r.header.cmd){case"hb":handleHeartbeatRsp(e,r);break;case"logout":handleLogoutRsp(e,r);break;case"custommsg":handleSendCustomMsgRsp(e,r);break;case"stream_info":handleFetchStreamListRsp(e,r);break;case"push_custommsg":handlePushCustomMsg(e,r);break;case"push_stream_update":handlePushStreamUpdateMsg(e,r);break;case"push_kickout":handlePushKickout(e,r);break;case"stream_url":handleFetchStreamUrlRsp(e,r);break;case"stream_publish":handleFetchStreamPublishUrlRsp(e,r);break;case"im_chat":handleSendRoomMsgRsp(e,r);break;case"push_im_chat":handlePushRoomMsg(e,r);break;case"push_userlist_update":handlePushUserStateUpdateMsg(e,r);break;case"user_list":handleFetchUserListRsp(e,r);break;case"push_signal":handlePushSignalMsg(e,r);break;case"stream":handleStreamUpdateRsp(e,r);break;case"trans":handleTransRsp(e,r);break;case"trans_fetch":handleFetchTransRsp(e,r);break;case"push_trans":handlePushTransMsg(e,r);break;case"push_merge_message":handlePushMergeMsg(e,r)}else e.logger.info("ws.bwsh.0 check session fail.");else handleLoginRsp(e,r)},e.websocket.onclose=function(t){e.logger.info("ws.oc.0 msg="+JSON.stringify(t)),e.runState!==ENUM_RUN_STATE.logout?e.runState===ENUM_RUN_STATE.trylogin&&e.tryLoginCount<=MAX_TRY_LOGIN_COUNT?e.logger.info("ws.oc.0 is called because of try login"):e.runState===ENUM_RUN_STATE.login?(e.logger.info("ws.oc.0 is called because of network broken, try again"),setRunState(e,ENUM_RUN_STATE.trylogin),resetTryLogin(e),tryLogin(e)):(e.logger.info("ws.oc.0 out of think!!!"),setRunState(e,ENUM_RUN_STATE.logout),resetRoom(e),e.onDisconnect(sdkErrorList.UNKNOWN)):e.logger.info("ws.oc.0 onclose logout flow call websocket.close")},e.websocket.onerror=function(t){e.logger.info("ws.oe.0 msg="+JSON.stringify(t))}}for(var registerNotifyList=["onDisconnect","onKickOut","onRecvCustomCommand","onStreamUpdated","onStreamExtraInfoUpdated","onPlayStateUpdate","onRecvRoomMsg","onUserStateUpdate","onGetTotalUserList","onPublishStateUpdate","onRecvJoinLiveRequest","onRecvInviteJoinLiveRequest","onRecvEndJoinLiveCommand","onStreamUrlUpdate","onGetAnchorInfo","onPublishQualityUpdate","onPlayQualityUpdate","onRecvReliableMessage","onRecvBigRoomMessage"],i=0;i<registerNotifyList.length;i++)ZegoClient.prototype[registerNotifyList[i]]=function(){};module.exports.ZegoClient=ZegoClient;
